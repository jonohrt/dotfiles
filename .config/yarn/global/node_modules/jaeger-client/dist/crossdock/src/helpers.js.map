{"version":3,"sources":["../../../crossdock/src/helpers.js"],"names":["constants","Helpers","tracer","_tracer","channel","makeSubChannel","serviceName","peers","myIp","crossdockSpec","readFileSync","join","__dirname","thriftChannel","source","bridge","_tracedChannel","tracedChannel","isStartRequest","traceRequest","serverSpan","setBaggageItem","BAGGAGE_KEY","baggage","sampled","setTag","Tags","SAMPLING_PRIORITY","prepareResponse","serverRole","downstream","Promise","resolve","reject","observedSpan","observeSpan","response","span","notImplementedError","log","json2str","callDownstream","then","downstreamResponse","transport","TRANSPORT_HTTP","callDownstreamHTTP","TRANSPORT_TCHANNEL","callDownstreamTChannel","TRANSPORT_DUMMY","port","parseInt","downstreamUrl","host","clientSpan","startSpan","childOf","context","headers","inject","FORMAT_HTTP_HEADERS","post","url","forever","body","JSON","stringify","err","finish","parse","setSpan","request","timeout","cn","trace","retryFlags","never","joinTraceRequest","send","observed","traceId","traceIdStr","isSampled","getBaggageItem","process","env","NODE_ENV","args","console","apply","json"],"mappings":"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","file":"helpers.js","sourcesContent":["// @flow\n// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport * as constants from './constants.js';\nimport fs from 'fs';\nimport path from 'path';\nimport dns from 'dns';\nimport DefaultContext from '../../src/default_context';\nimport opentracing from 'opentracing';\nimport request from 'request';\nimport RSVP from 'rsvp';\nimport Span from '../../src/span.js';\nimport SpanContext from '../../src/span_context.js';\nimport Tracer from '../../src/tracer.js';\nimport TChannel from 'tchannel/channel';\nimport TChannelThrift from 'tchannel/as/thrift';\nimport TChannelBridge from '../../src/tchannel_bridge';\nimport Utils from '../../src/util.js';\n\nexport default class Helpers {\n  _tracer: Tracer;\n  _bridge: TChannelBridge;\n  _tracedChannel: any;\n\n  constructor(tracer: Tracer) {\n    this._tracer = tracer;\n\n    var channel = TChannel().makeSubChannel({\n      serviceName: 'node',\n      peers: [Utils.myIp() + ':8082'],\n    });\n\n    let crossdockSpec = fs.readFileSync(\n      path.join(__dirname, '..', '..', 'src', 'jaeger-idl', 'thrift', 'crossdock', 'tracetest.thrift'),\n      'utf8'\n    );\n    let thriftChannel = TChannelThrift({\n      channel: channel,\n      source: crossdockSpec,\n    });\n\n    let bridge = new TChannelBridge(this._tracer);\n    this._tracedChannel = bridge.tracedChannel(thriftChannel);\n  }\n\n  handleRequest(isStartRequest: boolean, traceRequest: any, serverSpan: Span): void {\n    if (isStartRequest) {\n      serverSpan.setBaggageItem(constants.BAGGAGE_KEY, traceRequest.baggage);\n      if (traceRequest.sampled) {\n        serverSpan.setTag(opentracing.Tags.SAMPLING_PRIORITY, 1);\n      }\n    }\n\n    // do async call to prepareResponse\n    return this.prepareResponse(traceRequest.serverRole, traceRequest.downstream, serverSpan);\n  }\n\n  prepareResponse(serverRole: string, downstream: Downstream, serverSpan: Span): any {\n    return new RSVP.Promise((resolve, reject) => {\n      let observedSpan = this.observeSpan(serverSpan);\n      let response: TraceResponse = {\n        span: observedSpan,\n        notImplementedError: '',\n      };\n      Helpers.log(serverRole, 'observed span', Helpers.json2str(observedSpan));\n\n      if (downstream) {\n        this.callDownstream(serverRole, downstream, serverSpan).then(downstreamResponse => {\n          response.downstream = downstreamResponse;\n          Helpers.log(serverRole, 'returning response', Helpers.json2str(response));\n          resolve(response);\n        });\n      } else {\n        Helpers.log(serverRole, 'returning response', Helpers.json2str(response));\n        resolve(response);\n      }\n    });\n  }\n\n  callDownstream(serverRole: string, downstream: Downstream, serverSpan: Span): any {\n    Helpers.log(serverRole, 'calling downstream', Helpers.json2str(downstream));\n    let transport = downstream.transport;\n    if (transport === constants.TRANSPORT_HTTP) {\n      return this.callDownstreamHTTP(downstream, serverSpan);\n    } else if (transport === constants.TRANSPORT_TCHANNEL) {\n      return this.callDownstreamTChannel(downstream, serverSpan);\n    } else if (transport == constants.TRANSPORT_DUMMY) {\n      return new RSVP.Promise((resolve, reject) => {\n        resolve({ notImplementedError: 'Dummy has not been implemented' });\n      });\n    } else {\n      return new RSVP.Promise((resolve, reject) => {\n        resolve({ notImplementedError: `Unrecognized transport received: ${transport}` });\n      });\n    }\n  }\n\n  callDownstreamHTTP(downstream: Downstream, serverSpan: Span): any {\n    return new RSVP.Promise((resolve, reject) => {\n      let port = parseInt(downstream.port);\n      let downstreamUrl = `http://${downstream.host}:${port}/join_trace`;\n\n      let clientSpan = this._tracer.startSpan('client-span', { childOf: serverSpan.context() });\n      let headers = { 'Content-Type': 'application/json' };\n      this._tracer.inject(clientSpan.context(), opentracing.FORMAT_HTTP_HEADERS, headers);\n\n      request.post(\n        {\n          url: downstreamUrl,\n          forever: true,\n          headers: headers,\n          body: JSON.stringify({\n            serverRole: downstream.serverRole,\n            downstream: downstream.downstream,\n          }),\n        },\n        (err, response) => {\n          if (err) {\n            Helpers.log('error in downstream call:', err);\n            clientSpan.finish();\n            reject(err);\n            return;\n          }\n\n          clientSpan.finish();\n          let downstreamResponse = JSON.parse(response.body);\n          resolve(downstreamResponse);\n        }\n      );\n    });\n  }\n\n  callDownstreamTChannel(downstream: Downstream, serverSpan: Span): any {\n    return new RSVP.Promise((resolve, reject) => {\n      let port = parseInt(downstream.port);\n      let downstreamUrl = `http://${downstream.host}:${port}/join_trace`;\n\n      let context = new DefaultContext();\n      context.setSpan(serverSpan);\n      let request = this._tracedChannel.request({\n        timeout: 5000,\n        context: context,\n        headers: {\n          cn: 'tcollector-requestor',\n        },\n        trace: true,\n        serviceName: 'node',\n        retryFlags: { never: true },\n      });\n      let joinTraceRequest: JoinTraceRequest = {\n        serverRole: downstream.serverRole,\n      };\n\n      if (downstream.downstream) {\n        joinTraceRequest.downstream = downstream.downstream;\n      }\n\n      request.send('TracedService::joinTrace', null, { request: joinTraceRequest }, (err, response) => {\n        if (err) {\n          Helpers.log('tchannel err', err);\n          return;\n        }\n        resolve(response.body);\n      });\n    });\n  }\n\n  observeSpan(span: Span): ObservedSpan {\n    let observed: ObservedSpan = {\n      traceId: 'no span found',\n      sampled: false,\n      baggage: 'no span found',\n    };\n\n    if (span) {\n      observed = {\n        traceId: span.context().traceIdStr || '',\n        sampled: span.context().isSampled(),\n        baggage: span.getBaggageItem(constants.BAGGAGE_KEY),\n      };\n    }\n    return observed;\n  }\n\n  static log(...args: any[]): void {\n    // $FlowIgnore - stop complaining about property `env` not found\n    if (process.env.NODE_ENV !== 'test') {\n      console.log.apply(null, args);\n    }\n  }\n\n  static json2str(json: any): string {\n    return JSON.stringify(json);\n  }\n}\n"]}