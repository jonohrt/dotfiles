{"version":3,"sources":["../../../test/metrics/prometheus.js"],"names":["importPromClient","require","error","console","log","describe","metrics","PromClient","before","skip","it","name","createGauge","update","singleMetric","register","getSingleMetric","get","equal","type","values","value","clear","fakePromClient","to","throw","namespace","beforeEach","e","stack","afterEach","createCounter","increment","tags1","result","counter1","tags2","counter2","getMetricsAsJSON","length","deepEqual","labels"],"mappings":"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","file":"prometheus.js","sourcesContent":["// Copyright (c) 2018 Jaeger Author.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport { assert, expect } from 'chai';\nimport { PrometheusMetricsFactory } from '../../src/index.js';\n\nfunction importPromClient() {\n  try {\n    return require('prom-client');\n  } catch (error) {\n    console.log(\"cannot import 'prom-client', skipping tests\");\n    return null;\n  }\n}\n\ndescribe('Prometheus metrics', () => {\n  let metrics;\n  let PromClient;\n\n  before(function() {\n    PromClient = importPromClient();\n    if (!PromClient) {\n      this.skip();\n    }\n  });\n\n  it('should initialize without namespace', () => {\n    metrics = new PrometheusMetricsFactory(PromClient);\n    let name = 'jaeger:gauge';\n\n    metrics.createGauge(name).update(1);\n\n    let singleMetric = PromClient.register.getSingleMetric(name).get();\n    assert.equal(singleMetric.type, 'gauge');\n    assert.equal(singleMetric.name, name);\n    assert.equal(singleMetric.values[0].value, 1);\n    PromClient.register.clear();\n  });\n\n  it('should throw exception when initialized without prom-client object', () => {\n    expect(() => {\n      let fakePromClient = {};\n      metrics = new PrometheusMetricsFactory(fakePromClient);\n    }).to.throw('prom-client must be provided');\n  });\n});\n\ndescribe('Prometheus metrics with namespace', () => {\n  let metrics;\n  let PromClient;\n  let namespace = 'test';\n\n  before(function() {\n    PromClient = importPromClient();\n    if (!PromClient) {\n      this.skip();\n    }\n  });\n\n  beforeEach(() => {\n    try {\n      metrics = new PrometheusMetricsFactory(PromClient, namespace);\n    } catch (e) {\n      console.log('beforeEach failed', e);\n      console.log(e.stack);\n    }\n  });\n\n  afterEach(() => {\n    PromClient.register.clear();\n  });\n\n  it('should increment a counter with a provided value', () => {\n    let name = 'jaeger:counter';\n\n    metrics.createCounter(name).increment(1);\n\n    name = namespace + '_' + name;\n    let singleMetric = PromClient.register.getSingleMetric(name).get();\n    assert.equal(singleMetric.type, 'counter');\n    assert.equal(singleMetric.name, name);\n    assert.equal(singleMetric.values[0].value, 1);\n  });\n\n  it('should increment a tagged counter with a provided value', () => {\n    let name = 'jaeger:counter';\n\n    let tags1 = { result: 'ok' };\n    let counter1 = metrics.createCounter(name, tags1);\n    counter1.increment(1);\n    counter1.increment(1);\n\n    let tags2 = { result: 'err' };\n    let counter2 = metrics.createCounter(name, tags2);\n    counter2.increment(); // increment by 1\n\n    assert.equal(PromClient.register.getMetricsAsJSON().length, 1);\n    name = namespace + '_' + name;\n    let singleMetric = PromClient.register.getSingleMetric(name).get();\n    assert.equal(singleMetric.values.length, 2);\n    assert.deepEqual(singleMetric.values[0].labels, tags1);\n    assert.equal(singleMetric.values[0].value, 2);\n    assert.deepEqual(singleMetric.values[1].labels, tags2);\n    assert.equal(singleMetric.values[1].value, 1);\n  });\n\n  it('should update counter and gauge', () => {\n    metrics.createCounter('jaeger:counter', { result: 'ok' }).increment(1);\n    metrics.createCounter('jaeger:counter', { result: 'err' }).increment(1);\n    metrics.createGauge('jaeger:gauge', { result: 'ok' }).update(1);\n    metrics.createGauge('jaeger:gauge', { result: 'err' }).update(1);\n    assert.equal(PromClient.register.getMetricsAsJSON().length, 2);\n  });\n});\n"]}