{"version":3,"sources":["../../test/text_map_codec.js"],"names":["constants","describe","it","metrics","tracer","headers","context","extract","FORMAT_HTTP_HEADERS","isOk","counterEquals","decodingErrors","JAEGER_DEBUG_HEADER","encodeURIComponent","isDebugIDContainerOnly","equal","debugId","span","startSpan","childOf","isNotOk","parentId","traceId","isSampled","isDebug","tagFound","i","_tags","length","tag","key","value","tracesStartedSampled","debugThrottler","prevTagLength"],"mappings":"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","file":"text_map_codec.js","sourcesContent":["// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport { assert } from 'chai';\nimport * as constants from '../src/constants.js';\nimport ConstSampler from '../src/samplers/const_sampler.js';\nimport InMemoryReporter from '../src/reporters/in_memory_reporter.js';\nimport opentracing from 'opentracing';\nimport Tracer from '../src/tracer.js';\nimport Metrics from '../src/metrics/metrics.js';\nimport LocalMetricFactory from './lib/metrics/local/metric_factory.js';\nimport LocalBackend from './lib/metrics/local/backend.js';\nimport DefaultThrottler from '../src/throttler/default_throttler';\n\ndescribe('Text Map Codec should', () => {\n  it('report metric when failing to decode tracer state', () => {\n    let metrics = new Metrics(new LocalMetricFactory());\n    let tracer = new Tracer('test-tracer', new InMemoryReporter(), new ConstSampler(false), {\n      metrics: metrics,\n    });\n\n    let headers = {\n      'uber-trace-id': 'bad-value',\n    };\n    let context = tracer.extract(opentracing.FORMAT_HTTP_HEADERS, headers);\n\n    assert.isOk(context);\n    assert.isOk(LocalBackend.counterEquals(metrics.decodingErrors, 1));\n  });\n\n  it('set debug flag when debug-id-header is received', () => {\n    let metrics = new Metrics(new LocalMetricFactory());\n    let tracer = new Tracer('test-tracer', new InMemoryReporter(), new ConstSampler(false), {\n      metrics: metrics,\n    });\n    let headers = {};\n    headers[constants.JAEGER_DEBUG_HEADER] = encodeURIComponent('value1');\n\n    let context = tracer.extract(opentracing.FORMAT_HTTP_HEADERS, headers);\n    assert.isOk(context.isDebugIDContainerOnly());\n    assert.equal(context.debugId, 'value1');\n\n    let span = tracer.startSpan('root', { childOf: context });\n\n    assert.isNotOk(span.context().parentId);\n    assert.isOk(span.context().traceId !== 0);\n    assert.isOk(span.context().isSampled());\n    assert.isOk(span.context().isDebug());\n\n    let tagFound = false;\n    for (let i = 0; i < span._tags.length; i++) {\n      let tag = span._tags[i];\n      if (tag.key === constants.JAEGER_DEBUG_HEADER && span._tags[i].value === 'value1') {\n        tagFound = true;\n      }\n    }\n\n    assert.isOk(tagFound);\n\n    // metrics\n    assert.isOk(LocalBackend.counterEquals(metrics.tracesStartedSampled, 1));\n  });\n\n  it('not set debug flag when debug-id-header is received but operation is throttled', () => {\n    let tracer = new Tracer('test-tracer', new InMemoryReporter(), new ConstSampler(false), {\n      debugThrottler: new DefaultThrottler(true),\n    });\n    let headers = {};\n    headers[constants.JAEGER_DEBUG_HEADER] = encodeURIComponent('value1');\n\n    let context = tracer.extract(opentracing.FORMAT_HTTP_HEADERS, headers);\n    assert.isOk(context.isDebugIDContainerOnly());\n\n    let span = tracer.startSpan('root', { childOf: context });\n    let prevTagLength = span._tags.length;\n    assert.isNotOk(span.context().isDebug());\n    assert.equal(\n      prevTagLength,\n      span._tags.length,\n      'The sampling.priority tag should not be set if throttled'\n    );\n  });\n});\n"]}