{"version":3,"sources":["../../../test/lib/config_server.js"],"names":["ConfigServer","port","_port","_app","_strategies","get","_handleSampling","bind","_handleThrottling","serviceName","response","_credits","req","res","_handle","service","balances","getFunc","query","resp","send","status","err","_server","listen","close"],"mappings":";;;;;;;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;;;;;;;IAEqBA,Y;AAOnB,0BAAiC;AAAA,QAArBC,IAAqB,uEAAN,IAAM;;AAAA;;AAC/B,SAAKC,KAAL,GAAaD,IAAb;AACA,SAAKE,IAAL,GAAY,wBAAZ;AACA,SAAKC,WAAL,GAAmB,EAAnB;AACA,SAAKD,IAAL,CAAUE,GAAV,CAAc,WAAd,EAA2B,KAAKC,eAAL,CAAqBC,IAArB,CAA0B,IAA1B,CAA3B;AACA,SAAKJ,IAAL,CAAUE,GAAV,CAAc,UAAd,EAA0B,KAAKG,iBAAL,CAAuBD,IAAvB,CAA4B,IAA5B,CAA1B;AACD;;;;gCAEWE,W,EAAqBC,Q,EAA0C;AACzE,WAAKN,WAAL,CAAiBK,WAAjB,IAAgCC,QAAhC;AACD;;;+BAEUD,W,EAAqBC,Q,EAAuC;AACrE,WAAKC,QAAL,CAAcF,WAAd,IAA6BC,QAA7B;AACD;;;mCAEoB;AACnB,WAAKN,WAAL,GAAmB,EAAnB;AACA,WAAKO,QAAL,GAAgB,EAAhB;AACD;;;oCAEeC,G,EAAUC,G,EAAU;AAAA;;AAClC,WAAKC,OAAL,CAAaF,GAAb,EAAkBC,GAAlB,EAAuB,mBAAW;AAChC,eAAO,MAAKT,WAAL,CAAiBW,OAAjB,CAAP;AACD,OAFD;AAGD;;;sCAEiBH,G,EAAUC,G,EAAU;AAAA;;AACpC,WAAKC,OAAL,CAAaF,GAAb,EAAkBC,GAAlB,EAAuB,mBAAW;AAChC,eAAO,EAAEG,UAAU,OAAKL,QAAL,CAAcI,OAAd,CAAZ,EAAP;AACD,OAFD;AAGD;;;4BAEOH,G,EAAUC,G,EAAUI,O,EAAmB;AAC7C,UAAMF,UAAUH,IAAIM,KAAJ,CAAUH,OAA1B;AACA,UAAMI,OAAOF,QAAQF,OAAR,CAAb;AACA,UAAII,IAAJ,EAAU;AACRN,YAAIO,IAAJ,CAASD,IAAT;AACD,OAFD,MAEO;AACLN,YAAIQ,MAAJ,CAAW,GAAX,EAAgBD,IAAhB,CAAqB,EAAEE,iCAA8BP,OAA9B,OAAF,EAArB;AACD;AACF;;;4BAEqB;AACpB,WAAKQ,OAAL,GAAe,KAAKpB,IAAL,CAAUqB,MAAV,CAAiB,KAAKtB,KAAtB,CAAf;AACA,aAAO,IAAP;AACD;;;4BAEa;AACZ,WAAKqB,OAAL,CAAaE,KAAb;AACD;;;;;;kBAzDkBzB,Y","file":"config_server.js","sourcesContent":["// @flow\n// Copyright (c) 2016 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n// in compliance with the License. You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software distributed under the License\n// is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n// or implied. See the License for the specific language governing permissions and limitations under\n// the License.\n\nimport express from 'express';\n\nexport default class ConfigServer {\n  _port: number;\n  _app: any;\n  _server: any;\n  _strategies: { [service: string]: SamplingStrategyResponse };\n  _credits: { [service: string]: Array<CreditResponse> };\n\n  constructor(port: number = 5778) {\n    this._port = port;\n    this._app = express();\n    this._strategies = {};\n    this._app.get('/sampling', this._handleSampling.bind(this));\n    this._app.get('/credits', this._handleThrottling.bind(this));\n  }\n\n  addStrategy(serviceName: string, response: SamplingStrategyResponse): void {\n    this._strategies[serviceName] = response;\n  }\n\n  addCredits(serviceName: string, response: Array<CreditResponse>): void {\n    this._credits[serviceName] = response;\n  }\n\n  clearConfigs(): void {\n    this._strategies = {};\n    this._credits = {};\n  }\n\n  _handleSampling(req: any, res: any) {\n    this._handle(req, res, service => {\n      return this._strategies[service];\n    });\n  }\n\n  _handleThrottling(req: any, res: any) {\n    this._handle(req, res, service => {\n      return { balances: this._credits[service] };\n    });\n  }\n\n  _handle(req: any, res: any, getFunc: Function) {\n    const service = req.query.service;\n    const resp = getFunc(service);\n    if (resp) {\n      res.send(resp);\n    } else {\n      res.status(404).send({ err: `unknown service name '${service}'` });\n    }\n  }\n\n  start(): ConfigServer {\n    this._server = this._app.listen(this._port);\n    return this;\n  }\n\n  close(): void {\n    this._server.close();\n  }\n}\n"]}